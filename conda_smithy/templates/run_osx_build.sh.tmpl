#!/usr/bin/env bash

# turn this off as the output is far too verbose
# set -x

{{ fast_finish }}

echo "Installing a fresh version of Miniforge."
if [[ ${CI} == "travis" ]]; then
  echo -en 'travis_fold:start:install_miniforge\\r'
fi
MINIFORGE_URL="https://github.com/conda-forge/miniforge/releases/download/4.8.3-2"
MINIFORGE_FILE="Miniforge3-MacOSX-x86_64.sh"
curl -L -O "${MINIFORGE_URL}/${MINIFORGE_FILE}"
bash $MINIFORGE_FILE -b
if [[ ${CI} == "travis" ]]; then
  echo -en 'travis_fold:end:install_\\r'
fi

echo "Configuring conda."
if [[ ${CI} == "travis" ]]; then
  echo -en 'travis_fold:start:configure_conda\\r'
fi

source ${HOME}/miniforge3/etc/profile.d/conda.sh
conda activate base

echo "Installing conda-forge-ci-setup=2 and conda-build."
conda install -n base --quiet --yes conda-forge-ci-setup=2 conda-build

echo "Setting up the condarc and mangling the compiler."
setup_conda_rc ./ ./{{ recipe_dir }} ./.ci_support/${CONFIG}.yaml
mangle_compiler ./ ./{{ recipe_dir }} .ci_support/${CONFIG}.yaml

echo "Mangling homebrew in the CI to avoid conflicts."
if [[ ${CI} == "travis" ]]; then
  echo -en 'travis_fold:start:mangle_homebrew\\r'
fi
/usr/bin/sudo mangle_homebrew
/usr/bin/sudo -k
if [[ ${CI} == "travis" ]]; then
  echo -en 'travis_fold:end:mangle_homebrew\\r'
fi

{% if build_setup -%}
echo "Running the build setup script."
{{ build_setup }}
{%- endif %}
if [[ ${CI} == "travis" ]]; then
  echo -en 'travis_fold:end:configure_conda\\r'
fi

set -e

echo "Making the build clobber file and running the build."
make_build_number ./ ./{{ recipe_dir }} ./.ci_support/${CONFIG}.yaml
conda build ./{{ recipe_dir }} -m ./.ci_support/${CONFIG}.yaml --clobber-file ./.ci_support/clobber_${CONFIG}.yaml

if [[ "${UPLOAD_PACKAGES}" != "False" ]]; then
  echo "Uploading the packages."
  upload_package ./ ./{{ recipe_dir }} ./.ci_support/${CONFIG}.yaml
fi
