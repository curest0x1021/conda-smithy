{%- block env_branches -%}
{%- if not matrix -%}
general:
  branches:
    ignore:
      - /.*/

{% endif -%}
{% endblock -%}
{% block env_dependencies -%}
{%- if matrix -%}
checkout:
  post:
    # Checkout the merged PR for testing as CircleCI will just use the PR head otherwise.
    - if [[ -n "${CIRCLE_PR_NUMBER}" ]]; then git fetch origin +refs/pull/$CIRCLE_PR_NUMBER/head:pr/$CIRCLE_PR_NUMBER/head ; fi
    - if [[ -n "${CIRCLE_PR_NUMBER}" ]]; then git fetch origin +refs/pull/$CIRCLE_PR_NUMBER/merge:pr/$CIRCLE_PR_NUMBER/merge ; fi
    - if [[ -n "${CIRCLE_PR_NUMBER}" ]]; then git checkout -qf pr/$CIRCLE_PR_NUMBER/merge ; fi

machine:
  services:
    - docker

dependencies:
  # Note, we used to use the naive caching of docker images, but found that it was quicker
  # just to pull each time. #rollondockercaching
  override:
    - docker pull condaforge/linux-anvil

{% endif -%}
{% endblock -%}
test:
  override:
{%- block env_test %}
{%- if matrix %}
    # Run, test and (if we have a BINSTAR_TOKEN) upload the distributions.
    - ./ci_support/run_docker_build.sh
{% else %}
    # The Circle-CI build should not be active, but if this is not true for some reason, do a fast finish.
    - exit 0
{% endif -%}
{%- endblock %}
